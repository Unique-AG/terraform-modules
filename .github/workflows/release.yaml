name: "Create Module Release"

on:
  workflow_call:
    inputs:
      module:
        description: "Module to release"
        required: true
        type: string

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - run: |
          npm install yaml

      - id: module
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const yaml = require('yaml')
            const fs = require('fs')

            const modulePath = `modules/${{ inputs.module }}/module.yaml`
            const moduleContent = fs.readFileSync(modulePath, 'utf8')
            const moduleData = yaml.parse(moduleContent)

            // Extract module name and version
            const name = moduleData.name
            const version = moduleData.version

            // Format changes as markdown
            let changeLog = ''
            if (moduleData.changes && moduleData.changes.length > 0) {
              changeLog += '### Changes\n\n'
              changeLog += moduleData.changes.map(change =>
                `- **${change.kind}**: ${change.description}`
              ).join('\n')
              changeLog += '\n\n'
            }

            // Check for compatibility data
            if (moduleData.compatibility) {
              console.log("Raw compatibility data:", JSON.stringify(moduleData.compatibility));
              const compatibilityEntries = Object.entries(moduleData.compatibility)
                .map(([key, value]) => {
                  console.log(`Processing entry - Key: '${key}', Value: '${value}', Type of Key: ${typeof key}, Type of Value: ${typeof value}`);
                  return `- \`${key}\`: \`${value}\``;
                });
              console.log("Formatted compatibility entries:", compatibilityEntries);

              if (compatibilityEntries.length > 0) {
                changeLog += '### Compatibility\n\n'
                changeLog += compatibilityEntries.join('\n')
              }
            }

            // Add footer admonition about both tag formats
            changeLog += '\n\n---\n\n'
            changeLog += '> [!TIP]\n'
            changeLog += '> This release is available with both tag formats:\n'
            changeLog += `> - \`${name}-${version}\`\n`
            changeLog += `> - \`${name}@${version}\``

            core.setOutput('name', name)
            core.setOutput('version', version)
            core.setOutput('changes', changeLog)

      - name: Create Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_NOTES: ${{ steps.module.outputs.changes }} # must be passed as ENV else the backticks will get escaped and not shown as code
          MODULE_NAME: ${{ steps.module.outputs.name }}
          MODULE_VERSION: ${{ steps.module.outputs.version }}
        run: |
          # Create and push both tag formats
          git tag "${MODULE_NAME}-${MODULE_VERSION}"
          git tag "${MODULE_NAME}@${MODULE_VERSION}"
          git push origin "${MODULE_NAME}-${MODULE_VERSION}" "${MODULE_NAME}@${MODULE_VERSION}"

          # Create GitHub release with @ separator
          gh release create \
            "${MODULE_NAME}@${MODULE_VERSION}" \
            --title "${MODULE_NAME}@${MODULE_VERSION}" \
            --notes "$RELEASE_NOTES" \
            --target ${{ github.sha }}

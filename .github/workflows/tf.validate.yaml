name: "[terraform] Lint & Secure"
on:
  pull_request:
    branches:
      - main
    paths:
      - modules/**/*.tf
      - .github/workflows/tf.validate.yaml
      - .github/configs/**
      - scripts/**

permissions:
  contents: read

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.12.0
      - name: Generate Documentation
        run: |
          ./scripts/tf-docs.sh
          if [[ $(git diff --stat) != '' ]]; then
            echo -e '\033[0;31mDocumentation outdated!\033[0m ❌'
            git diff --color
            exit 1
          else
            echo -e '\033[0;32mDocumentation up to date\033[0m ✔'
          fi

      - name: Format Terraform
        run: |
          ./scripts/tf-fmt.sh
          if [[ $(git diff --stat) != '' ]]; then
            echo -e '\033[0;31mTerraform not formatted!\033[0m ❌'
            git diff --color
            exit 1
          else
            echo -e '\033[0;32mTerraform format up to date\033[0m ✔'
          fi

      - name: Changes
        run: ./scripts/lint-changes.sh

      - name: Examples
        run: ./scripts/examples.sh

      - name: Report
        run: ./scripts/trivy.sh trivy.sarif

      # agreed with security, we run on PR for simplicity for now until we have no findings. from then on we can block PRs that introduce new findings.
      - name: Upload Sarif results
        uses: github/codeql-action/upload-sarif@181d5eefc20863364f96762470ba6f862bdef56b #v3.29.2
        with:
          sarif_file: trivy.sarif

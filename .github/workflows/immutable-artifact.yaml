name: "Validate Module Release"

on:
  workflow_call:
    inputs:
      module:
        description: "Module to release"
        required: true
        type: string

jobs:
  validate-release:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

      - run: |
          npm install yaml

      - id: validate
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const yaml = require('yaml')
            const fs = require('fs')

            const modulePath = `modules/${{ inputs.module }}/module.yaml`
            const moduleContent = fs.readFileSync(modulePath, 'utf8')
            const moduleData = yaml.parse(moduleContent)

            // Extract module name and version
            const name = moduleData.name
            const version = moduleData.version
            const tagName = `${name}-${version}`

            // Check if release already exists
            try {
              const existingRelease = await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag: tagName
              })
              console.log(`❌ Release ${tagName} already exists`)
              core.setFailed(`Release ${tagName} already exists. Cannot create duplicate release.`)
            } catch (error) {
              if (error.status === 404) {
                console.log(`✅ Release ${tagName} does not exist, validation passed`)
              } else {
                throw error
              }
            }
